# =============================================================================
# Tessera — Production Docker Compose
# =============================================================================
# Usage:
#   1. cp .env.production.example .env.production   (fill in secrets)
#   2. docker compose -f docker-compose.prod.yml --env-file .env.production up -d --build
#   3. Point your reverse proxy / Cloudflare Tunnel at http://localhost:8080
#
# TLS is handled by your external reverse proxy (Cloudflare Tunnel, Caddy,
# nginx, Traefik, etc.) — Tessera exposes plain HTTP on port 8080.
# =============================================================================

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "5"
    tag: "{{.Name}}"

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: tessera-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-tessera}
      POSTGRES_USER: ${DB_USER:-tessera}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - tessera-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-tessera} -d ${DB_NAME:-tessera}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
    logging: *default-logging

  # ===========================================
  # Redis (Sessions, Cache, Job Queue)
  # ===========================================
  redis:
    image: redis:7.4-alpine
    container_name: tessera-redis
    restart: unless-stopped
    command: >
      redis-server
        --appendonly yes
        --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
        --maxmemory 256mb
        --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - tessera-network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli --no-auth-warning -a $$REDIS_PASSWORD ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: "0.5"
        reservations:
          memory: 64M
    logging: *default-logging

  # ===========================================
  # MinIO (S3-Compatible Object Storage)
  # ===========================================
  minio:
    image: minio/minio:RELEASE.2025-02-07T23-21-09Z
    container_name: tessera-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:?MINIO_ACCESS_KEY is required}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:?MINIO_SECRET_KEY is required}
    volumes:
      - minio-data:/data
    networks:
      - tessera-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
    logging: *default-logging

  # ===========================================
  # MinIO Setup (Creates bucket on startup)
  # ===========================================
  minio-setup:
    image: minio/mc:RELEASE.2025-02-08T15-01-12Z
    container_name: tessera-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set tessera http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY};
      mc mb tessera/$${MINIO_BUCKET:-tessera-files} --ignore-existing;
      mc anonymous set none tessera/$${MINIO_BUCKET:-tessera-files};
      exit 0;
      "
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET:-tessera-files}
    networks:
      - tessera-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
    logging: *default-logging

  # ===========================================
  # Go Backend API (Production)
  # ===========================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: tessera-backend
    restart: unless-stopped
    environment:
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-tessera}
      DB_USER: ${DB_USER:-tessera}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_SSLMODE: ${DB_SSLMODE:-disable}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET:-tessera-files}
      MINIO_USE_SSL: "false"
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_EXPIRY: ${JWT_EXPIRY:-15m}
      JWT_REFRESH_EXPIRY: ${JWT_REFRESH_EXPIRY:-168h}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?ENCRYPTION_KEY is required}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10737418240}
      CHUNK_SIZE: ${CHUNK_SIZE:-10485760}
      FRONTEND_URL: ${FRONTEND_URL:-https://tessera.local}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - tessera-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/ready"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 128M
    logging: *default-logging

  # ===========================================
  # Vue Frontend + Nginx Reverse Proxy
  # ===========================================
  # Nginx serves the Vue SPA and proxies /api/* and /webdav/* to the backend.
  # This is the only container that exposes a port — point your external
  # reverse proxy (Cloudflare Tunnel, Caddy, etc.) at this.
  # ===========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: tessera-frontend
    restart: unless-stopped
    ports:
      - "${TESSERA_PORT:-8080}:8080"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - tessera-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
        reservations:
          memory: 32M
    logging: *default-logging

  # ===========================================
  # Database Backup (pg_dump cron)
  # ===========================================
  backup:
    build:
      context: ./docker/backup
      dockerfile: Dockerfile
    container_name: tessera-backup
    restart: unless-stopped
    environment:
      DB_HOST: postgres
      DB_USER: ${DB_USER:-tessera}
      DB_NAME: ${DB_NAME:-tessera}
      DB_PASSWORD: ${DB_PASSWORD}
      BACKUP_CRON: ${BACKUP_CRON:-0 2 * * *}
      BACKUP_RETAIN_DAYS: ${BACKUP_RETAIN_DAYS:-30}
    volumes:
      - ./backups:/backups
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - tessera-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    logging: *default-logging

  # ===========================================
  # Prometheus (Metrics Collection) - DISABLED
  # Uncomment to enable metrics collection.
  # ===========================================
  # prometheus:
  #   image: prom/prometheus:v2.54.0
  #   container_name: tessera-prometheus
  #   restart: unless-stopped
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--storage.tsdb.retention.time=15d'
  #     - '--web.enable-lifecycle'
  #   volumes:
  #     - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #   networks:
  #     - tessera-network
  #   depends_on:
  #     backend:
  #       condition: service_healthy
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M
  #         cpus: "0.5"
  #   logging: *default-logging

  # ===========================================
  # Grafana (Metrics Visualization) - DISABLED
  # Uncomment to enable dashboards.
  # ===========================================
  # grafana:
  #   image: grafana/grafana:11.4.0
  #   container_name: tessera-grafana
  #   restart: unless-stopped
  #   environment:
  #     GF_SECURITY_ADMIN_USER: admin
  #     GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-tessera_grafana}
  #     GF_USERS_ALLOW_SIGN_UP: "false"
  #   volumes:
  #     - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
  #     - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
  #     - grafana-data:/var/lib/grafana
  #   networks:
  #     - tessera-network
  #   depends_on:
  #     - prometheus
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 256M
  #         cpus: "0.5"
  #   logging: *default-logging

networks:
  tessera-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  minio-data:
  # prometheus-data:
  # grafana-data:
